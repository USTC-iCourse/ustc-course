{% extends "layout.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    .chat-main {
        display: flex;
        flex-direction: column;
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }
    .chat-input {
        border-top: 1px solid #dee2e6;
        padding: 20px;
    }
    .message {
        margin-bottom: 20px;
        max-width: 80%;
        position: relative;
    }
    .message-user {
        background-color: #f1f0f0;
        border-radius: 18px 18px 0 18px;
        padding: 10px 15px;
        align-self: flex-end;
    }
    .message-assistant {
        background-color: #e3f2fd;
        border-radius: 18px 18px 18px 0;
        padding: 10px 15px;
    }
    .message-content {
        margin-bottom: 5px;
    }
    .message-timestamp {
        font-size: 0.8em;
        color: #6c757d;
        position: absolute;
        right: 10px;
        bottom: 5px;
    }
    .loading-animation {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .ai-status {
        font-style: italic;
        color: #6c757d;
        margin-bottom: 10px;
    }
    .intent-analysis, .search-results {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .performance-stats {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 5px;
    }
    .conversation-list-item {
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        transition: background-color 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .conversation-list-item:hover {
        background-color: #e9ecef;
    }
    .conversation-list-item.active {
        background-color: #007bff;
        color: #fff;
    }
    .btn-icon {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-icon i {
        margin-right: 8px;
    }
    .delete-conversation {
        color: #dc3545;
        cursor: pointer;
    }
    .input-group {
        display: flex;
        align-items: stretch;
    }
    #message-input {
        flex-grow: 1;
        resize: vertical;
        min-height: 38px;
        max-height: 200px;
        overflow-y: auto;
    }
    #send-message {
        margin-left: 10px;
        align-self: stretch;
    }
    .conversation-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80%;
    }
    .loading-dots {
        display: inline-block;
    }
    .loading-dots:after {
        content: '.';
        animation: dots 1s steps(5, end) infinite;
    }
    @keyframes dots {
        0%, 20% {
            color: rgba(0,0,0,0);
            text-shadow:
                .25em 0 0 rgba(0,0,0,0),
                .5em 0 0 rgba(0,0,0,0);
        }
        40% {
            color: black;
            text-shadow:
                .25em 0 0 rgba(0,0,0,0),
                .5em 0 0 rgba(0,0,0,0);
        }
        60% {
            text-shadow:
                .25em 0 0 black,
                .5em 0 0 rgba(0,0,0,0);
        }
        80%, 100% {
            text-shadow:
                .25em 0 0 black,
                .5em 0 0 black;
        }
    }
</style>

<div class="container chat-container">
    <div class="row">
        <div class="col-md-3 chat-sidebar">
            <button id="create-conversation" class="btn btn-primary btn-block mb-3 btn-icon">
                <i class="fas fa-plus"></i>
                <span>New Conversation</span>
            </button>
            <div id="conversation-list"></div>
        </div>
        <div class="col-md-9 chat-main d-flex flex-column">
            <div id="chat-messages" class="chat-messages flex-grow-1"></div>
            <div class="chat-input mt-auto">
                <div class="input-group">
                    <textarea id="message-input" class="form-control" rows="1" placeholder="Type your message..."></textarea>
                    <button id="send-message" class="btn btn-primary btn-icon">
                        <i class="fas fa-paper-plane"></i>
                        <span>Send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        let currentConversationId = null;
        const csrfToken = "{{ csrf_token() }}";

        function loadConversations() {
            $.get('/chat/conversations', function(conversations) {
                $('#conversation-list').empty();
                conversations.forEach(function(conversation) {
                    $('#conversation-list').append(
                        `<div class="conversation-list-item" data-id="${conversation.id}">
                            <div class="conversation-title">
                                <i class="fas fa-comments mr-2"></i>
                                ${conversation.first_query || `Conversation ${conversation.id}`}
                            </div>
                            <i class="fas fa-trash delete-conversation" data-id="${conversation.id}"></i>
                        </div>`
                    );
                });
                if (conversations.length > 0 && !currentConversationId) {
                    loadConversation(conversations[0].id);
                } else if (conversations.length === 0) {
                    createConversation();
                }
            });
        }

        function loadConversation(conversationId) {
            currentConversationId = conversationId;
            $('.conversation-list-item').removeClass('active');
            $(`.conversation-list-item[data-id="${conversationId}"]`).addClass('active');
            $('#chat-messages').empty();
            $.get(`/chat/conversations/${conversationId}/messages`, function(messages) {
                messages.forEach(function(message) {
                    appendMessage(message);
                });
                scrollToBottom();
            });
        }

        function createConversation() {
            $.post('/chat/conversations', function(conversation) {
                currentConversationId = conversation.id;
                loadConversations();
                $('#chat-messages').empty();
                sendGreeting();
            });
        }

        function deleteConversation(conversationId) {
            $.ajax({
                url: `/chat/conversations/${conversationId}`,
                type: 'DELETE',
                success: function() {
                    loadConversations();
                    if (currentConversationId === conversationId) {
                        $('#chat-messages').empty();
                        currentConversationId = null;
                    }
                },
                error: function() {
                    alert('Failed to delete conversation');
                }
            });
        }

        function sendGreeting() {
            const greetingMessage = {
                role: 'assistant',
                content: "Hello! I'm your AI assistant. How can I help you today?"
            };
            appendMessage(greetingMessage);
        }

        function appendMessage(message) {
            const searchResultsHtml = generateSearchResultsHtml(message.search_results);
            const messageHtml = generateMessageHtml(message, searchResultsHtml);
            $('#chat-messages').append(messageHtml);
            highlightCodeBlocks();
            scrollToBottom();
        }

        function generateSearchResultsHtml(searchResults) {
            if (!searchResults) return '';
            let parsedResults;
            if (typeof searchResults === 'string') {
                try {
                    parsedResults = JSON.parse(searchResults);
                } catch (e) {
                    console.error('Failed to parse search results:', e);
                    return '';
                }
            } else {
                parsedResults = searchResults;
            }
            if (Array.isArray(parsedResults) && parsedResults.length > 0) {
                return `
                    <div class="search-results">
                        <h4>Search Results:</h4>
                        <ul>
                            ${parsedResults.map(result => {
                                if (result.type === 'course') {
                                    return `
                                        <li>
                                            Course <a href="/course/${result.data.id}">${result.data.name_with_teachers_short}</a>
                                        </li>
                                    `;
                                } else if (result.type === 'review') {
                                    return `
                                        <li>
                                            Review <a href="/course/${result.data.course_id}#review-${result.data.id}">${result.data.name_with_teachers_short} by ${result.data.author}</a>
                                        </li>
                                    `;
                                }
                            }).join('')}
                        </ul>
                    </div>
                `;
            }
            return '';
        }

        function generateMessageHtml(message, searchResultsHtml) {
            return `
                <div class="message message-${message.role}">
                    ${generateIntentAnalysisHtml(message.intent_analysis)}
                    ${searchResultsHtml}
                    <div class="message-content">${marked.parse(message.content)}</div>
                    ${generatePerformanceStatsHtml(message.timing_stats)}
                    <div class="message-timestamp">${new Date(message.created_at).toLocaleString()}</div>
                </div>
            `;
        }

        function generateIntentAnalysisHtml(intentAnalysis) {
            if (!intentAnalysis) return '';
            let parsedAnalysis;
            if (typeof intentAnalysis === 'string') {
                try {
                    parsedAnalysis = JSON.parse(intentAnalysis);
                } catch (e) {
                    console.error('Failed to parse intent analysis:', e);
                    return '';
                }
            } else {
                parsedAnalysis = intentAnalysis;
            }

            if (!Array.isArray(parsedAnalysis) || parsedAnalysis.length === 0) {
                return '';
            }

            return `
                <div class="intent-analysis">
                    <h4>Intent Analysis</h4>
                    <ul>
                        ${parsedAnalysis.map(item => `
                            ${item.function ? `
                            <li>
                                <strong>${item.function}:</strong>
                                ${item.args ? `
                                    <ul>
                                        ${Object.entries(item.args).map(([key, value]) => `
                                            <li><em>${key}:</em> ${value}</li>
                                    `).join('')}
                                </ul>
                                ` : '<p>No arguments</p>'}
                            </li>
                            ` : ''}
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        function generatePerformanceStatsHtml(timingStats) {
            if (!timingStats) return '';
            let stats;
            if (typeof timingStats === 'string') {
                try {
                    stats = JSON.parse(timingStats);
                } catch (e) {
                    console.error('Failed to parse timing stats:', e);
                    return '';
                }
            } else {
                stats = timingStats;
            }
            return `
                <div class="performance-stats">
                    <div style="font-style: italic;">
                        ${Object.entries(stats).map(([key, value]) => {
                            if (typeof value === 'number' && value !== 0) {
                                const humanReadableKey = key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                                return `<span style="margin-right: 15px;"><strong>${humanReadableKey}:</strong> ${value.toFixed(2)}</span>`;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function highlightCodeBlocks() {
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showLoadingAnimation() {
            const $lastAssistantMessage = $('.message-assistant:last');
            if ($lastAssistantMessage.find('.loading-dots').length === 0) {
                $lastAssistantMessage.append('<div class="loading-dots">Thinking</div>');
            }
        }

        function hideLoadingAnimation() {
            $('.loading-dots').remove();
        }

        function sendMessage() {
            const message = $('#message-input').val().trim();
            if (message && currentConversationId) {
                $('#message-input').val('');
                appendMessage({role: 'user', content: message, created_at: new Date()});

                // Update conversation title with first query
                if ($(`#conversation-list .conversation-list-item[data-id="${currentConversationId}"] .conversation-title`).text().trim() === `Conversation ${currentConversationId}`) {
                    $(`#conversation-list .conversation-list-item[data-id="${currentConversationId}"] .conversation-title`).text(message);
                }

                // Immediately append an empty assistant message
                let assistantMessage = {
                    role: 'assistant',
                    content: '',
                    created_at: new Date(),
                    intent_analysis: '',
                    search_results: '',
                    timing_stats: ''
                };
                appendMessage(assistantMessage);
                showLoadingAnimation();

                fetch(`/chat/conversations/${currentConversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ message: message })
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processChunk({ done, value }) {
                        if (done) {
                            hideLoadingAnimation();
                            return;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop();

                        lines.forEach(line => {
                            if (line.trim() === 'data: [DONE]') {
                                // Do nothing, as we're updating the message in real-time
                            } else if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    processStreamData(data);
                                } catch (e) {
                                    console.error('Error parsing JSON:', e);
                                }
                            }
                        });

                        return reader.read().then(processChunk);
                    }

                    return reader.read().then(processChunk);
                }).catch((e) => {
                    console.error('Error processing stream:', e);
                    assistantMessage.content = 'Sorry, there was an error processing your request.';
                    updateAssistantMessage(assistantMessage);
                    hideLoadingAnimation();
                });

                function processStreamData(data) {
                    if (data.type === 'intent_analysis') {
                        assistantMessage.intent_analysis = data.content;
                    } else if (data.type === 'search_results') {
                        assistantMessage.search_results = data.content;
                    } else if (data.type === 'ai_response') {
                        assistantMessage.content += data.content;
                    } else if (data.type === 'timing_stats') {
                        assistantMessage.timing_stats = data.content;
                    }
                    updateAssistantMessage(assistantMessage);
                }
            }
        }

        function updateAssistantMessage(message) {
            const $lastAssistantMessage = $('.message-assistant:last');
            $lastAssistantMessage.html(`
                ${generateIntentAnalysisHtml(message.intent_analysis)}
                ${generateSearchResultsHtml(message.search_results)}
                <div class="message-content">${marked.parse(message.content)}</div>
                ${generatePerformanceStatsHtml(message.timing_stats)}
                <div class="message-timestamp">${new Date(message.created_at).toLocaleString()}</div>
            `);
            highlightCodeBlocks();
            scrollToBottom();
        }

        $('#create-conversation').click(createConversation);
        $('#send-message').click(sendMessage);
        $('#message-input').on('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        $('#message-input').keydown(function(e) {
            if (e.which === 13 && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        $(document).on('click', '.conversation-list-item', function(e) {
            if (!$(e.target).hasClass('delete-conversation')) {
                loadConversation($(this).data('id'));
            }
        });
        $(document).on('click', '.delete-conversation', function(e) {
            e.stopPropagation();
            if (confirm('Are you sure you want to delete this conversation?')) {
                deleteConversation($(this).data('id'));
            }
        });

        loadConversations();
    });
</script>
{% endblock %}
