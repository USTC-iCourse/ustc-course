{% extends "layout.html" %}
{% block content %}

<div class="container">
  <div class="row float-element">
  <div class="row">
  <div class="col-md-9">
    <div class="inline-h3">
    <span class="blue h4">{% if not is_new %}编辑{% endif %}点评 &bull; <a href="{{ url_for('course.view_course', course_id=course.id) }}">{{ course.name }}{% if course.teachers %}（{{ course.teacher_names_display|name_display_short }}）{% endif %}</a></span>
    <span class="align-bottom left-pd-sm desktop">学期：{{ review.term|term_display }} &nbsp;课程号：{{ course.courseries }}</span>
    <br><span class="align-bottom mobile">学期：{{ review.term|term_display }} &nbsp;课程号：{{ course.courseries }}</span>
    </div>
    <hr>
    {% if message != '' %}
    <div class="alert alert-danger">{{ message }}</div>
    {% endif %}
    {% include 'review-hidden.html' %}
    <form id="review-form" class="form-horizontal" method="post" action="{{ url_for('course.new_review', course_id=course.id) }}">
      {{ form.csrf_token }}
      <div class="rate-part ud-pd-md">
        <div class="ud-pd-sm">
          <span class="right-pd-sm weight-heavy">学　　期</span>

          <select name="term">
            {% set joined_term = course.joined_term() %}
            {% if not joined_term %}
              <option value="">请选择学期</option>
            {% endif %}

            {% for term in course.term_ids %}
              <option value="{{ term }}" {% if review.term == term or ((not review.term or review.term not in course.term_ids) and joined_term == term) %}selected="selected"{% endif %}>{{ term|term_display }}
              {% if joined_term == term %}(学过){% endif %}
              </option>
            {% endfor %}
          </select>
          {% if (not review.term or review.term not in course.term_ids) and not joined_term %}
          <span class="grey">&nbsp;如果不记得了，可以随便选一个 :)</span>
          {% endif %}
          <span class="clearfix"></span>
        </div>

        {% for poll in polls %}
        <div class="review-poll ud-pd-sm">
          <span class="right-pd-sm weight-heavy">{{ poll['display'] }}</span>
          <div class="btn-group btn-group-inv" data-toggle="buttons">
            {% for option in poll['options'] %}
            <label class="btn btn-flat btn-grey rl-mg-sm {% if review[poll['name']] == loop.index %}active{% endif %}">
                <input type="radio" name="{{ poll['name'] }}" autocomplete="off" value="{{ loop.index }}" {% if review[poll['name']] == loop.index %}checked{% endif %}>
                {{ option }}
            </label>
            {% endfor %}
          </div>
        </div>
        {% endfor %}

        <link rel="stylesheet" href="/static/css/star-rating.min.css" media="all" rel="stylesheet" type="text/css">
        <div class="ud-pd-sm">
          <span class="weight-heavy pull-left">评个分吧？</span>
          <div class="pull-right">
            <input id="clear-rating-checkbox" type="checkbox" style="margin-right: 5px;">
            <label for="clear-rating-checkbox" style="font-weight: normal; margin-bottom: 0; cursor: pointer;">只写点评不评分</label>
          </div>
          <div id="rate-star-container" style="clear: both; padding-top: 5px;">
            <input id="rate-star" name="rate" value="{{ review.rate / 2.0 if review.rate else 0 }}">
          </div>
          <span class="clearfix"></span>
        </div>
      </div>

      <div>
        <h4 class="grey">说几句吧！</h4>
        <div class="ud-pd-sm">
          <textarea id="content-editor" name="content">{% if review.content %}{{ review.content }}{% endif %}</textarea>
        </div>
      </div>

      <div class="ud-pd-sm"></div>
      <div class="class-control">
        <input {% if review.is_anonymous %}checked{% endif %} id="is_anonymous" name="is_anonymous" type="checkbox" value="1">
        <label for="is_anonymous">匿名发表点评
          {% if review.author.is_teacher %}
          (由于您是教师用户，即使匿名发表点评，也会标注“教师点评”，但不会暴露您的用户名和头像)
          {% endif %}
        </label>
      </div>
      <div class="class-control">
        <input {% if review.only_visible_to_student %}checked{% endif %} id="only_visible_to_student" name="only_visible_to_student" type="checkbox" value="1">
        <label for="only_visible_to_student">仅登录学生用户可见</label>
      </div>

      <div class="desktop">
        <button type="submit" class="btn btn-blue btn-flat float-right shadow">发布</button>
      </div>
      <div class="container mobile">
        <button type="submit" class="btn btn-blue float-right">发布</button>
      </div>

      <div class="ud-pd-lg"></div>

    </form>
  </div>
  </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="/static/js/star-rating.min.js" type="text/javascript"></script>
<script>
function submit_review() {
    var url = "{{ url_for('course.new_review', course_id=course.id) }}";
    var data = $('#review-form').serializeArray().reduce(function(obj, item) {
        obj[item.name] = item.value;
        return obj;
    }, {});
    data['rate'] = Math.round(data['rate'] * 2);
    if (data['rate'] == 0) {
        data['rate'] = undefined;
    }
    data['is_ajax'] = true;
    console.log(url);
    console.log(data);
    $.post(url, data, function(o) {
        console.log(o);
        if (!o.ok) {
            alert('Failed to submit review, please try again!');
        } else {
            // remove auto saved content
            localStorage.removeItem(autoSaveKey);
            window.location.href = o.next_url;
        }
    }, 'json')
    .fail(function() {
        alert('提交点评失败，请重试！');
    });
}

$(function(){
    // remove desktop/mobile-only elements to avoid name conflicts
    if ($('.desktop').css('display') == 'none') {
        $('.desktop').remove();
    }
    if ($('.mobile').css('display') == 'none') {
        $('.mobile').remove();
    }

    var allowUnrated = false;
    var autoSaveKey = 'review_draft' + window.location.pathname;

    // Helper: Get editor content
    function getEditorContent() {
        return window.editor ? window.editor.getData() : $('textarea[name=content]').val();
    }

    // Helper: Set editor content
    function setEditorContent(content) {
        if (window.editor) {
            window.editor.setData(content);
        } else {
            $('textarea[name=content]').val(content);
        }
    }

    // Helper: Restore poll selection
    function restorePoll(name, value) {
        if (value) {
            $('input[name=' + name + '][value=' + value + ']').prop('checked', true)
                .parent().addClass('active');
        }
    }

    // Helper: Apply "review only" mode styling
    function applyReviewOnlyMode() {
        $('.rating-container .star').addClass('disabled').css('pointer-events', 'none').css('opacity', '0.5');
        $('.star-rating .caption .blue').text("你可以提交没有评分的点评 :)");
    }

    // Auto-save function
    function autoSave() {
        var draftData = {
            term: $('select[name=term]').val(),
            difficulty: $('input[name=difficulty]:checked').val(),
            homework: $('input[name=homework]:checked').val(),
            grading: $('input[name=grading]:checked').val(),
            gain: $('input[name=gain]:checked').val(),
            rate: $('#rate-star').val(),
            content: getEditorContent(),
            is_anonymous: $('#is_anonymous').is(':checked'),
            only_visible_to_student: $('#only_visible_to_student').is(':checked'),
            clear_rating_checkbox: $('#clear-rating-checkbox').is(':checked'),
            timestamp: new Date().getTime()
        };
        localStorage.setItem(autoSaveKey, JSON.stringify(draftData));
        console.log('Draft auto-saved at ' + new Date(draftData.timestamp).toLocaleTimeString());
    }

    // Restore saved draft
    function restoreDraft() {
        var savedData = localStorage.getItem(autoSaveKey);
        if (!savedData) return;

        try {
            var draftData = JSON.parse(savedData);

            // Check if draft is not too old (e.g., 7 days)
            var daysSinceLastSave = (new Date().getTime() - draftData.timestamp) / (1000 * 60 * 60 * 24);
            if (daysSinceLastSave > 7) {
                localStorage.removeItem(autoSaveKey);
                return;
            }

            // Check if draft has any meaningful content
            var hasContent = draftData.content && draftData.content.trim().length > 0;
            var hasRatings = draftData.difficulty || draftData.homework || draftData.grading || draftData.gain || (draftData.rate && draftData.rate > 0);

            if (!hasContent && !hasRatings) {
                return; // Empty draft, skip restore
            }

            // Auto-restore without confirmation
            console.log('Auto-restoring draft from ' + new Date(draftData.timestamp).toLocaleString());

            // Restore term
            if (draftData.term) {
                $('select[name=term]').val(draftData.term);
            }

            // Restore poll selections
            restorePoll('difficulty', draftData.difficulty);
            restorePoll('homework', draftData.homework);
            restorePoll('grading', draftData.grading);
            restorePoll('gain', draftData.gain);

            // Restore checkboxes
            $('#is_anonymous').prop('checked', draftData.is_anonymous);
            $('#only_visible_to_student').prop('checked', draftData.only_visible_to_student);

            // Restore content
            if (draftData.content) {
                setEditorContent(draftData.content);
            }

            // Restore clear rating checkbox
            if (draftData.clear_rating_checkbox) {
                $('#clear-rating-checkbox').prop('checked', true);
                allowUnrated = true;
            }

            // Restore rate (needs to happen after star rating is fully initialized)
            if (draftData.rate && draftData.rate > 0) {
                $('#rate-star').rating('update', draftData.rate);
            }

            // Apply review-only mode styling if needed
            if (draftData.clear_rating_checkbox) {
                applyReviewOnlyMode();
            }
        } catch (e) {
            console.error('Failed to restore draft:', e);
            localStorage.removeItem(autoSaveKey);
        }
    }

    function startStarRating() {
        $('#rate-star').rating({
            min: 0,
            max: 5,
            step: 0.5,
            size: "xs",
            showClear: false,
            glyphicon: false,
            ratingClass: 'glyphicon glyphicon-star',
            starCaptions: function(val) {
                return val*2;
            },
            starCaptionClasses: function(val) {
                return "blue";
            },
        });
    }
    
    function toggleRatingMode() {
        if ($('#clear-rating-checkbox').is(':checked')) {
            // Show confirm dialog to encourage rating
            var confirmed = confirm('评分能帮助其他同学更好地选课，建议您为课程评个分哦！\n\n确定要只写点评不评分吗？');
            
            if (!confirmed) {
                // User cancelled, uncheck the checkbox
                $('#clear-rating-checkbox').prop('checked', false);
                return;
            }
            
            // Enable "review only" mode
            allowUnrated = true;
            $('#rate-star').val(0).trigger('change');
            
            // Clear all poll selections (课程难度, 作业多少, 给分好坏, 收获多少)
            $('.review-poll input[type="radio"]:checked').prop('checked', false);
            $('.review-poll .btn.active').removeClass('active');
            applyReviewOnlyMode();
        } else {
            // Re-enable rating mode
            allowUnrated = false;
            $('.rating-container .star').removeClass('disabled').css('pointer-events', 'auto').css('opacity', '1');
            // Reset caption
            $('.star-rating .caption .blue').text("0");
        }
    }

    startStarRating();

    // Auto-save on input changes
    $('select[name=term]').on('change', autoSave);
    $('.review-poll input[type=radio]').on('change', autoSave);
    $('#rate-star').on('change', autoSave);
    $('#is_anonymous').on('change', autoSave);
    $('#only_visible_to_student').on('change', autoSave);
    $('#clear-rating-checkbox').on('change', function() {
        toggleRatingMode();
        autoSave();
    });

    // Wait for CKEditor 5 to be ready, then setup auto-save and restore draft
    var editorCheckInterval = setInterval(function() {
        if (window.editor) {
            clearInterval(editorCheckInterval);

            // Listen to CKEditor 5 changes
            window.editor.model.document.on('change:data', debounce(autoSave, 1000));

            // Restore draft after both CKEditor and star rating are ready
            setTimeout(function() {
                restoreDraft();
            }, 300);
        }
    }, 100);

    // Debounce function to avoid too frequent saves
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    $('#review-form').submit(function(e) {
        e.preventDefault();

        if ($('select[name=term]').val() == '') {
            alert('请选择学期，如果不记得了，可以随便选一个 :)');
            return;
        }
        var difficultyUnrated = ($('input[name=difficulty]:radio:checked').length == 0);
        var homeworkUnrated = ($('input[name=homework]:radio:checked').length == 0);
        var gradingUnrated = ($('input[name=grading]:radio:checked').length == 0);
        var gainUnrated = ($('input[name=gain]:radio:checked').length == 0);
        var overallUnrated = ($('input[name=rate]').val() <= 0 || $('input[name=rate]').val() > 5);
        if (!allowUnrated) {
            if (difficultyUnrated) {
                alert('请选择课程难度！');
                return;
            }
            if (homeworkUnrated) {
                alert('请选择作业多少！');
                return;
            }
            if (gradingUnrated) {
                alert('请选择给分好坏！');
                return;
            }
            if (gainUnrated) {
                alert('请选择收获多少！');
                return;
            }
            if (overallUnrated) {
                alert('请评分！');
                return;
            }
        } else {
            if (difficultyUnrated || homeworkUnrated || gradingUnrated || gainUnrated || overallUnrated) {
                if (!(difficultyUnrated && homeworkUnrated && gradingUnrated && gainUnrated && overallUnrated)) {
                    alert('如果要评分，请完整评分，不能只评总分，也不能只评课程难度、作业多少、给分好坏、收获多少 :)');
                    return;
                }
            }
        }

        var content_html = $('textarea[name=content]').val();
        var content_text = content_html.replace(/(<([^>]+)>)/ig, "");
        if (content_text.trim().length < 10) {
            alert('点评内容太短啦！（需长于10字符）');
            return;
        }

        submit_review();
    });

    $('.review-poll .btn').click(function(e) {
        if ($(this).hasClass('active')) {
            setTimeout(function() {
                $(this).removeClass('active');
                $(this).find('input').removeAttr('checked');
            }.bind(this), 10);
        }
    });
});
</script>
{% include 'richeditor.html' %}
{% endblock %}
